# Transport Brain - Aplikační diagramy

> **Verze:** 3.9.0  
> **Datum:** Prosinec 2025

---

## 📊 PŘEHLED STRÁNEK

```
┌─────────────────────────────────────────────────────────────┐
│                    TRANSPORT BRAIN                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Dashboard  │  │  Documents  │  │   Prices    │         │
│  │  /dashboard │  │   /upload   │  │   /prices   │         │
│  │             │  │             │  │             │         │
│  │ Přehled     │  │ Upload PDF  │  │ Ceníky per  │         │
│  │ fakturace   │  │ smluv       │  │ typ+depo    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ AlzaBox BI  │  │  Carriers   │  │  Expected   │         │
│  │  /alzabox   │  │  /carriers  │  │  /expected  │         │
│  │             │  │             │  │             │         │
│  │ Drill-down  │  │ Správa      │  │ Očekávaná   │         │
│  │ dojezdy     │  │ dopravců    │  │ fakturace   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🏭 STRUKTURA CENÍKŮ (Prices.jsx)

```
┌─────────────────────────────────────────────────────────────┐
│                    SPRÁVA CENÍKŮ                            │
│  Přehled sazeb podle typu služby (pouze aktivní)            │
│                                          [Dopravce: ▼]      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📦 AlzaBox                    2 depa • 1 aktivní ceník│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                      │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ 🏭 Depo Vratimov                             │    │   │
│  │  │    Linehaul z CZTC1/CZLC4 → třídění → rozvoz │    │   │
│  │  ├─────────────────────────────────────────────┤    │   │
│  │  │ LINEHAUL DO DEPA VRATIMOV                   │    │   │
│  │  │ ┌───────────────────────────────────────┐   │    │   │
│  │  │ │ Z Úžice (CZTC1):                      │   │    │   │
│  │  │ │   Dodávka (8-10 pal)       9 100 Kč   │   │    │   │
│  │  │ │   Solo (15-18 pal)        14 800 Kč   │   │    │   │
│  │  │ │   Kamion (33 pal)         22 000 Kč   │   │    │   │
│  │  │ │                                       │   │    │   │
│  │  │ │ Z Chrášťan (CZLC4):                   │   │    │   │
│  │  │ │   Dodávka (8-10 pal)      10 100 Kč   │   │    │   │
│  │  │ │   Solo (18-21 pal)        16 500 Kč   │   │    │   │
│  │  │ │   Kamion (33 pal)         24 180 Kč   │   │    │   │
│  │  │ └───────────────────────────────────────┘   │    │   │
│  │  │                                             │    │   │
│  │  │ ROZVOZ Z DEPA (dodávky)                     │    │   │
│  │  │ ┌───────────┐┌───────────┐┌───────────┐     │    │   │
│  │  │ │ 💰 FIX    ││ 📍 KM     ││ 🏭 DEPO   │     │    │   │
│  │  │ │ 2 500 Kč  ││ 10,97/km  ││ 850 Kč/h  │     │    │   │
│  │  │ └───────────┘└───────────┘└───────────┘     │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                      │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ 📦 Depo Nový Bydžov                          │    │   │
│  │  │    Linehaul + Direct trasy + sklad           │    │   │
│  │  ├─────────────────────────────────────────────┤    │   │
│  │  │ LINEHAUL DO DEPA NOVÝ BYDŽOV                │    │   │
│  │  │ ┌───────────────────────────────────────┐   │    │   │
│  │  │ │ Z Úžice (CZTC1): Dodávka/Solo/Kamion  │   │    │   │
│  │  │ │ Z Chrášťan (CZLC4): Dodávka/Solo/Kam. │   │    │   │
│  │  │ └───────────────────────────────────────┘   │    │   │
│  │  │                                             │    │   │
│  │  │ DIRECT TRASY (rozvoz z depa)                │    │   │
│  │  │ ┌───────────────┐┌───────────────┐          │    │   │
│  │  │ │ 💰 FIX        ││ 📍 KM sazba   │          │    │   │
│  │  │ │ 3 200 Kč      ││ 10,97 Kč/km   │          │    │   │
│  │  │ └───────────────┘└───────────────┘          │    │   │
│  │  │                                             │    │   │
│  │  │ SKLADOVÉ SLUŽBY                             │    │   │
│  │  │ ┌───────────────┐┌───────────────┐          │    │   │
│  │  │ │ 🏭 Sklad      ││ 🏆 Bonus ≥98% │          │    │   │
│  │  │ │ 410 000/měs   ││ +35 600 Kč    │          │    │   │
│  │  │ └───────────────┘└───────────────┘          │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Rozvozová depa:                                      │   │
│  │ 🏭 Vratimov (Linehaul + rozvoz)                     │   │
│  │ 📦 Nový Bydžov (Direct + sklad)                     │   │
│  │ • Expediční sklady: CZTC1 (Úžice), CZLC4 (Chrášťany)│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📦 ALZABOX BI - DRILL-DOWN

```
┌─────────────────────────────────────────────────────────────┐
│            ALZABOX BI - VČASNOST DOJEZDŮ                    │
│                                                             │
│  Level 1: PŘEHLED TRAS                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Trasa          │ Boxů │ Dojezdů │ Včas   │ Status   │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ Praha A1       │   45 │    1350 │ 99.2%  │ 🟢       │   │
│  │ Praha B2       │   38 │    1140 │ 97.5%  │ 🟠       │   │
│  │ Vratimov C1    │   52 │    1560 │ 94.1%  │ 🔴       │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓ klik                             │
│                                                             │
│  Level 2: DETAIL TRASY (Praha A1)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Box            │ Dojezdů │ Včas   │ Poslední │      │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ AB-PRG-001     │      30 │ 100%   │ 08:45    │ 🟢   │   │
│  │ AB-PRG-002     │      30 │ 96.7%  │ 09:12    │ 🟠   │   │
│  │ AB-PRG-003     │      30 │ 93.3%  │ 09:35    │ 🔴   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          ↓ klik                             │
│                                                             │
│  Level 3: DETAIL BOXU (AB-PRG-002)                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📍 AlzaBox AB-PRG-002                               │   │
│  │ Adresa: Václavské nám. 1, Praha 1                   │   │
│  │ Trasa: Praha A1 | Dopravce: Drivecool               │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                      │   │
│  │  📊 Včasnost: 96.7%        📈 Trend: ↗ +1.2%        │   │
│  │                                                      │   │
│  │  ┌──────────────────────────────────┐               │   │
│  │  │ Graf trendu za období            │               │   │
│  │  │    ___/‾‾‾\___/‾‾‾‾              │               │   │
│  │  │   /                               │               │   │
│  │  │  1  5  10  15  20  25  30        │               │   │
│  │  └──────────────────────────────────┘               │   │
│  │                                                      │   │
│  │  📋 Historie dojezdů:                               │   │
│  │  │ Datum      │ Plán  │ Skutečnost │ Status │       │   │
│  │  │ 3.12.2025  │ 09:00 │ 09:12      │ ❌     │       │   │
│  │  │ 2.12.2025  │ 09:00 │ 08:55      │ ✅     │       │   │
│  │  │ 1.12.2025  │ 09:00 │ 08:58      │ ✅     │       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📄 UPLOAD SMLUV - FLOW

```
┌─────────────────────────────────────────────────────────────┐
│                    UPLOAD SMLOUVY                           │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  1. VALIDACE NÁZVU SOUBORU                                  │
│     Regex: /con.*\d{5,}/i                                   │
│     ✅ con30076-dodatek.pdf                                 │
│     ❌ faktura_123.pdf                                      │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  2. PDF PARSING (pdfplumber)                                │
│     └─ Extrakce textu ze všech stran                       │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  3. EXTRAKCE INFO                                           │
│     ├─ extract_carrier_info() → IČO, DIČ, název            │
│     ├─ extract_contract_info() → číslo, datum, typ         │
│     └─ extract_price_rates() → FIX, KM, DEPO, Linehaul     │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  4. VALIDACE DOPRAVCE                                       │
│     IČO ve smlouvě == IČO vybraného dopravce?              │
│     ✅ Shoda → pokračuj                                     │
│     ❌ Neshoda → chyba 400                                  │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  5. ULOŽENÍ DO DB                                           │
│     ├─ Contract (smlouva)                                   │
│     ├─ PriceConfig (ceník)                                  │
│     │   ├─ FixRate[]                                        │
│     │   ├─ KmRate[]                                         │
│     │   ├─ DepoRate[]                                       │
│     │   ├─ LinehaulRate[]                                   │
│     │   └─ BonusRate[]                                      │
│     └─ commit                                               │
└─────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│  6. RESPONSE                                                │
│     {                                                       │
│       "contract_id": 1,                                     │
│       "price_config_id": 1,                                 │
│       "extracted_rates": {                                  │
│         "fix_rates": [...],                                 │
│         "km_rates": [...],                                  │
│         "linehaul_rates": [...]                             │
│       }                                                     │
│     }                                                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🗄️ DATABASE SCHEMA

```
┌─────────────────┐       ┌─────────────────┐
│    Carrier      │       │    Contract     │
├─────────────────┤       ├─────────────────┤
│ id              │───┐   │ id              │
│ name            │   │   │ carrier_id   ◄──┼───┐
│ ico             │   │   │ number          │   │
│ dic             │   └──►│ type            │   │
│ address         │       │ valid_from      │   │
│ active          │       │ document_url    │   │
└─────────────────┘       └────────┬────────┘   │
                                   │            │
                                   ▼            │
                          ┌─────────────────┐   │
                          │  PriceConfig    │   │
                          ├─────────────────┤   │
                          │ id              │   │
                          │ carrier_id   ◄──┼───┘
                          │ contract_id  ◄──┤
                          │ type            │
                          │ valid_from      │
                          │ is_active       │
                          └────────┬────────┘
                                   │
        ┌──────────┬───────────┬───┴───┬───────────┬──────────┐
        ▼          ▼           ▼       ▼           ▼          ▼
   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
   │ FixRate │ │ KmRate  │ │DepoRate │ │Linehaul │ │BonusRate│
   │         │ │         │ │         │ │  Rate   │ │         │
   └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘


┌─────────────────┐       ┌─────────────────┐
│AlzaBoxLocation  │       │ AlzaBoxDelivery │
├─────────────────┤       ├─────────────────┤
│ id              │───┐   │ id              │
│ alza_id         │   │   │ location_id  ◄──┼───┘
│ name            │   │   │ delivery_type   │
│ address         │   │   │ route_name      │
│ city            │   │   │ planned_time    │ (String!)
│ country         │   │   │ actual_time     │
│ route_name      │   │   │ on_time         │
└─────────────────┘       └─────────────────┘
```

---

## 🔐 AUTH FLOW

```
┌──────────────────────────────────────────────────────────┐
│                     LOGIN FLOW                            │
└──────────────────────────────────────────────────────────┘

┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐
│ Browser │     │Frontend │     │ Backend │     │   DB    │
└────┬────┘     └────┬────┘     └────┬────┘     └────┬────┘
     │               │               │               │
     │  Otevře app   │               │               │
     │──────────────►│               │               │
     │               │               │               │
     │               │ Check localStorage            │
     │               │ (logged_in?)  │               │
     │               │               │               │
     │   [NOT LOGGED]│               │               │
     │◄──────────────│               │               │
     │  Login form   │               │               │
     │               │               │               │
     │  Submit       │               │               │
     │──────────────►│               │               │
     │               │ POST /api/auth/login          │
     │               │──────────────►│               │
     │               │               │ INSERT        │
     │               │               │──────────────►│
     │               │               │ LoginLog      │
     │               │               │◄──────────────│
     │               │  200 OK       │               │
     │               │◄──────────────│               │
     │               │               │               │
     │               │ Set localStorage              │
     │               │ logged_in=true│               │
     │               │               │               │
     │  Show app     │               │               │
     │◄──────────────│               │               │
     │               │               │               │
```

---

*Aktualizováno: Prosinec 2025 - v3.9.0*
