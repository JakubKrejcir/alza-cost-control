generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Carrier {
  id        Int        @id @default(autoincrement())
  name      String
  ico       String?
  dic       String?
  address   String?
  contact   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  depots    Depot[]
  contracts Contract[]
  prices    PriceConfig[]
  proofs    Proof[]
  invoices  Invoice[]
}

model Depot {
  id        Int      @id @default(autoincrement())
  carrierId Int
  carrier   Carrier  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  name      String
  code      String?
  type      String?
  address   String?
  createdAt DateTime @default(now())
  linehaulFrom LinehaulRate[] @relation("FromDepot")
  linehaulTo   LinehaulRate[] @relation("ToDepot")
  proofs    Proof[]

  @@index([carrierId])
}

model Contract {
  id          Int           @id @default(autoincrement())
  carrierId   Int
  carrier     Carrier       @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  number      String
  type        String?
  validFrom   DateTime
  validTo     DateTime?
  documentUrl String?
  notes       String?
  createdAt   DateTime      @default(now())
  prices      PriceConfig[]

  @@index([carrierId])
}

model PriceConfig {
  id           Int            @id @default(autoincrement())
  carrierId    Int
  carrier      Carrier        @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  contractId   Int?
  contract     Contract?      @relation(fields: [contractId], references: [id])
  type         String
  validFrom    DateTime
  validTo      DateTime?
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  fixRates     FixRate[]
  kmRates      KmRate[]
  depoRates    DepoRate[]
  linehaulRates LinehaulRate[]
  bonusRates   BonusRate[]

  @@index([carrierId])
  @@index([type, validFrom])
}

model FixRate {
  id            Int         @id @default(autoincrement())
  priceConfigId Int
  priceConfig   PriceConfig @relation(fields: [priceConfigId], references: [id], onDelete: Cascade)
  routeType     String
  rate          Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())

  @@index([priceConfigId])
}

model KmRate {
  id            Int         @id @default(autoincrement())
  priceConfigId Int
  priceConfig   PriceConfig @relation(fields: [priceConfigId], references: [id], onDelete: Cascade)
  routeType     String?
  rate          Decimal     @db.Decimal(10, 4)
  createdAt     DateTime    @default(now())

  @@index([priceConfigId])
}

model DepoRate {
  id            Int         @id @default(autoincrement())
  priceConfigId Int
  priceConfig   PriceConfig @relation(fields: [priceConfigId], references: [id], onDelete: Cascade)
  depoName      String
  rateType      String
  rate          Decimal     @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())

  @@index([priceConfigId])
}

model LinehaulRate {
  id            Int         @id @default(autoincrement())
  priceConfigId Int
  priceConfig   PriceConfig @relation(fields: [priceConfigId], references: [id], onDelete: Cascade)
  fromDepotId   Int?
  fromDepot     Depot?      @relation("FromDepot", fields: [fromDepotId], references: [id])
  toDepotId     Int?
  toDepot       Depot?      @relation("ToDepot", fields: [toDepotId], references: [id])
  fromCode      String?
  toCode        String?
  vehicleType   String
  rate          Decimal     @db.Decimal(10, 2)
  isPosila      Boolean     @default(false)
  description   String?

  @@index([priceConfigId])
}

model BonusRate {
  id            Int         @id @default(autoincrement())
  priceConfigId Int
  priceConfig   PriceConfig @relation(fields: [priceConfigId], references: [id], onDelete: Cascade)
  qualityMin    Decimal     @db.Decimal(5, 2)
  qualityMax    Decimal     @db.Decimal(5, 2)
  bonusAmount   Decimal     @db.Decimal(10, 2)
  totalWithBonus Decimal    @db.Decimal(10, 2)
  createdAt     DateTime    @default(now())

  @@index([priceConfigId])
}

model Proof {
  id             Int       @id @default(autoincrement())
  carrierId      Int
  carrier        Carrier   @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  depotId        Int?
  depot          Depot?    @relation(fields: [depotId], references: [id])
  period         String
  periodDate     DateTime
  fileName       String?
  fileUrl        String?
  status         String    @default("pending")
  totalFix       Decimal?  @db.Decimal(12, 2)
  totalKm        Decimal?  @db.Decimal(12, 2)
  totalLinehaul  Decimal?  @db.Decimal(12, 2)
  totalDepo      Decimal?  @db.Decimal(12, 2)
  totalBonus     Decimal?  @db.Decimal(12, 2)
  totalPenalty   Decimal?  @db.Decimal(12, 2)
  grandTotal     Decimal?  @db.Decimal(12, 2)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  routeDetails   ProofRouteDetail[]
  linehaulDetails ProofLinehaulDetail[]
  depoDetails    ProofDepoDetail[]
  invoices       Invoice[]
  analyses       ProofAnalysis[]

  @@index([carrierId])
  @@index([period])
}

model ProofRouteDetail {
  id        Int     @id @default(autoincrement())
  proofId   Int
  proof     Proof   @relation(fields: [proofId], references: [id], onDelete: Cascade)
  routeType String
  count     Int
  rate      Decimal @db.Decimal(10, 2)
  amount    Decimal @db.Decimal(12, 2)

  @@index([proofId])
}

model ProofLinehaulDetail {
  id          Int     @id @default(autoincrement())
  proofId     Int
  proof       Proof   @relation(fields: [proofId], references: [id], onDelete: Cascade)
  description String
  fromCode    String?
  toCode      String?
  vehicleType String?
  days        Int?
  perDay      Int?
  rate        Decimal @db.Decimal(10, 2)
  total       Decimal @db.Decimal(12, 2)

  @@index([proofId])
}

model ProofDepoDetail {
  id       Int     @id @default(autoincrement())
  proofId  Int
  proof    Proof   @relation(fields: [proofId], references: [id], onDelete: Cascade)
  depoName String
  rateType String
  days     Int?
  rate     Decimal @db.Decimal(10, 2)
  amount   Decimal @db.Decimal(12, 2)

  @@index([proofId])
}

model Invoice {
  id              Int      @id @default(autoincrement())
  carrierId       Int
  carrier         Carrier  @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  proofId         Int?
  proof           Proof?   @relation(fields: [proofId], references: [id])
  invoiceNumber   String
  period          String
  issueDate       DateTime?
  dueDate         DateTime?
  totalWithoutVat Decimal? @db.Decimal(12, 2)
  vatAmount       Decimal? @db.Decimal(12, 2)
  totalWithVat    Decimal? @db.Decimal(12, 2)
  status          String   @default("pending")
  fileUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  items           InvoiceItem[]

  @@index([carrierId])
  @@index([period])
  @@index([proofId])
}

model InvoiceItem {
  id          Int     @id @default(autoincrement())
  invoiceId   Int
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  itemType    String
  description String?
  amount      Decimal @db.Decimal(12, 2)

  @@index([invoiceId])
}

model ProofAnalysis {
  id              Int      @id @default(autoincrement())
  proofId         Int
  proof           Proof    @relation(fields: [proofId], references: [id], onDelete: Cascade)
  status          String
  errorsJson      String?
  warningsJson    String?
  okJson          String?
  diffFix         Decimal? @db.Decimal(12, 2)
  diffKm          Decimal? @db.Decimal(12, 2)
  diffLinehaul    Decimal? @db.Decimal(12, 2)
  diffDepo        Decimal? @db.Decimal(12, 2)
  missingRatesJson String?
  createdAt       DateTime @default(now())

  @@index([proofId])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  entityType String
  entityId   Int
  action     String
  userId     String?
  changes    String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
}
